import matplotlib.pyplot as plt
from flask import Blueprint, request
import numpy as np
import utils
from statistics import mean
from db import *
import json

graph = Blueprint('graphs', __name__)


def show_word_frequency(word):
    userIds = []
    usage = []
    userNames = []
    for tweet in search_by_keywords(word):
        if tweet['userId'] not in userIds:
            userIds.append(tweet['userId'])
            usage.append(1)
        else:
            usage[userIds.index(tweet['userId'])] += 1
    for userId in userIds:
        usr = searchUserId(userId)
        for username in usr:
            userNames.append(username['name'])

    n = np.arange(len(userNames))
    plt.bar(n, usage)
    plt.xticks(n, userNames)
    plt.title('NÃºmero de menciones de "{}"'.format(word))
    plt.show()


@graph.route('/graphs', methods=['GET'])
def show_favs_rts():
    word = request.args.get('word')
#x = media de RTS, y =MEDIA DE FAVS, r =NUMERO DE TWEETS

    userIds = []
    usage = []
    sumFavs = []
    mediaFavs = []
    sumRts= []
    mediaRts = []
    userNames = []
    for tweet in search_by_keywords(word):

        if tweet['userId'] not in userIds:
            userIds.append(tweet['userId'])
            usage.append(1)

            f = tweet['favorite_count']
            sumFavs.append(f[-1])

            r = tweet['retweet_count']
            sumRts.append(r[-1])

        else:
            usage[userIds.index(tweet['userId'])] += 1
            f = tweet['favorite_count']
            sumFavs[userIds.index(tweet['userId'])] += f[-1]

            r = tweet['retweet_count']
            sumRts[userIds.index(tweet['userId'])] += r[-1]

    for userId in userIds:
        usr = searchUserId(userId)
        for username in usr:
            userNames.append(username['name'])

    o = [{"x": x, "y": y, "z": z} for x,y,z in zip(sumRts, sumFavs, usage)]
    m = [{"Label": l, "data": d} for l, d in zip(userNames, o)]

    pprint(json.dumps(m))
    bubble_response = json.dumps(m)
    return utils.JSONResponse(bubble_response)






